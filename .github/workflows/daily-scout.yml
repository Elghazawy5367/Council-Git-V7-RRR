name: Council Daily Scout

on:
  schedule:
    # Runs at 6 AM UTC daily (2 AM EST, 11 PM PST)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Manual trigger via GitHub UI
    inputs:
      target_niche:
        description: 'Specific niche to scout (optional)'
        required: false
        default: 'developer tools'
      depth:
        description: 'Scan depth (shallow/normal/deep)'
        required: false
        default: 'normal'

permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  scout-mission:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline
      
      - name: ğŸ“ Create Data Directories
        run: |
          mkdir -p data/cache
          mkdir -p data/intelligence
          mkdir -p data/reports
          mkdir -p data/opportunities
      
      - name: ğŸ¯ Run The Sonar (Market Scanner)
        id: sonar
        run: npx tsx src/lib/scout.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_NICHE: ${{ github.event.inputs.target_niche || 'developer tools' }}
          SCAN_DEPTH: ${{ github.event.inputs.depth || 'normal' }}
        continue-on-error: true
      
      - name: ğŸ“Š Generate Intelligence Report
        if: always()
        run: npx tsx src/lib/report-generator.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ’¾ Save Intelligence to Repository
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ” Council Daily Intelligence Report - ${{ github.run_number }}"
          file_pattern: |
            data/**/*.json
            data/**/*.md
          commit_user_name: Council Scout Bot
          commit_user_email: scout@council.bot
          commit_author: Council Scout <scout@council.bot>
      
      - name: ğŸ“ˆ Upload Intelligence Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: council-intelligence-${{ github.run_number }}
          path: |
            data/reports/*.md
            data/opportunities/*.json
          retention-days: 90
      
      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "::error::Scout mission failed. Check logs for details."
          exit 1
      
      - name: âœ… Mission Summary
        if: success()
        run: |
          echo "ğŸ¯ Scout Mission Complete"
          echo "ğŸ“Š Reports generated in data/reports/"
          echo "ğŸ’¡ Opportunities saved in data/opportunities/"
          ls -lh data/reports/ 2>/dev/null || echo "No reports yet"
          ls -lh data/opportunities/ 2>/dev/null || echo "No opportunities yet"

  # Optional: Weekly deep scan (more comprehensive)
  deep-scout:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 * * 0'  # Sundays only
    timeout-minutes: 60
    
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ“ Create Data Directories
        run: mkdir -p data/{cache,intelligence,reports,opportunities}
      
      - name: ğŸ”¬ Deep Market Analysis
        run: npx tsx src/lib/scout.ts --deep
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCAN_DEPTH: 'deep'
      
      - name: ğŸ’¾ Save Deep Intelligence
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”¬ Council Weekly Deep Scan - ${{ github.run_number }}"
          file_pattern: data/**/*
